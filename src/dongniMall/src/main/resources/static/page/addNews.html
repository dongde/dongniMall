
<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>最新文章管理</title>
    <script src="../lib/layui-v2.5.4/layui.js" charset="utf-8"></script>
    <script src="../js/lay-config.js" charset="utf-8"></script>
    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta http-equiv="Access-Control-Allow-Origin" content="*">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <link rel="icon" href="../images/favicon.ico">
    <link rel="stylesheet" href="../lib/layui-v2.5.4/css/layui.css" media="all">
    <link rel="stylesheet" href="../css/layuimini.css" media="all">
    <link rel="stylesheet" href="../css/public.css" media="all">
    <link rel="stylesheet" href="../lib/font-awesome-4.7.0/css/font-awesome.min.css" media="all">


    <style>
        .imageSize{
            height: 150px;
            width: 150px;
        }


    </style>


</head>
<body>
<form class="layui-form" type="multipart">
        <div class="layui-form-item">
            <label class="layui-form-label">标题</label>
            <div class="layui-input-block">
                <input type="text" name="title" lay-verify="title" autocomplete="off" placeholder="请输入标题" class="layui-input" id="title">
            </div><span id="titleJudge"></span>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">来源</label>
            <div class="layui-input-block">
                <input type="text" name="source" lay-verify="title" autocomplete="off" placeholder="请输入来源" class="layui-input" id="source">
            </div>
        </div>
        <div class="layui-form-item layui-form-text">
            <label class="layui-form-label">摘要</label>
            <div class="layui-input-block">
                <textarea placeholder="请输入内容" class="layui-textarea" name="summary" id="summary"></textarea>
            </div><span id="summaryJudge"></span>
        </div>

    <div class="layui-form-item">
        <label class="layui-form-label">缩略图</label>
            <div class="layui-input-inline uploadHeadImage">
                <button type="button" class="layui-btn" id="uploadImage">上传图片</button>
                <div class="layui-upload-list" id="hidebutton" style="display:none;">
                    <img class="imageSize" id="upload">
                    <p id="errupload"></p>
                </div>
            </div>
        </div>


    <input type="text" style="display: none" name="url" id="urlSubmit" >
        <div class="layui-form-item">
            <label class="layui-form-label">内容</label>
            <div class="layui-input-block">
                <textarea id="contents" style="display: none;" placeholder="请输入内容" name="content"></textarea>
            </div>
        </div>
        <div class="layui-form-item">
            <div class="layui-input-block">
                <button class="layui-btn" lay-submit lay-filter="formSubmint" id="commit">立即提交</button>
         </div>
        </div>
</form>

    <script>

        //表单提交
        layui.use(['form', 'layedit',"upload","layer", "element"],function(){
            var layedit = layui.layedit;
            //富文本编辑器的图片上传
            layedit.set({
                uploadImage: {
                    url: '/list/uploadBanner' //接口url
                    ,type: 'post' //默认post
                }
            });

            var index = layedit.build('contents'); //建立富文本编辑器
            var form = layui.form,
                layer = layui.layer,
                $ = layui.jquery;
                element = layui.element,
                upload = layui.upload;



            //监听提交
            form.on('submit(formSubmint)', function(data){
                data.field.content = layedit.getContent(index);
                var loading = layer.load(0,{shade:false});
                $.ajax({
                    url:"/add/article",
                    type:"post",
                    data:data.field,
                    success:function (res) {
                        if(res.status==200){
                            layer.msg('添加成功', {
                                icon: 1,//提示的样式
                                time: 1000, //2秒关闭（如果不配置，默认是3秒）//设置后不需要自己写定时关闭了，单位是毫秒
                                end: function () {
                                    layer.close(loading);
                                    window.parent.location.reload();
                                }
                            });

                        }else {
                            layer.msg(res.msg, {
                                icon: 5,//提示的样式
                                time: 2000, //2秒关闭（如果不配置，默认是3秒）//设置后不需要自己写定时关闭了，单位是毫秒
                                end: function () {
                                    layer.close(loading);
                                    window.location.reload();
                                }
                            });

                        }
                    }
                });
                return false;
             });



            //图片上传
            var uploadInst = upload.render({
                elem: '#uploadImage'
                , url: '/list/uploadBanner'
                , size: 5000
                ,acceptMime:'image/*'
                , before: function (obj) {
                    $("#hidebutton").css("display","block");
                    //预读本地文件示例，不支持ie8
                    obj.preview(function (index, file, result) {
                        $('#upload').attr('src', result); //图片链接（base64）
                    });
                }
                , done: function (res) {
                    //如果上传失败
                    if (res.code!= 0) {
                            return layer.msg('上传失败');
                    }
                    //打印后台传回的地址: 把地址放入一个隐藏的input中, 和表单一起提交到后台
                    document.getElementById("urlSubmit").value = res.data.url;
                    //上传成功

                    /*   console.log(res.data.src);*/
                    var errupload = $('#errupload');
                    errupload.html('<span style="color: #8f8f8f;">上传成功!!!</span>');

                }
                , error: function () {
                    var errupload = $('#errupload');
                    errupload.html('<span style="color: #FF5722;">上传失败</span> <a class="layui-btn layui-btn-mini demo-reload">重试</a>');
                    errupload.find('.demo-reload').on('click', function () {
                        uploadInst.upload();
                    });
                }
            });
            element.init();
            form.render();

 });



    </script>
</body>

</html>